<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EVE Tracker</title>
</head>
<body>
  <h1>EVE Tracker</h1> 

  <!-- Страница авторизации -->
  <div style="display:flex; gap:12px; align-items:center; padding:12px; border:1px solid #ddd; border-radius:12px; max-width:520px;" id="login-container">
    <button id="loginBtn" style="padding:10px 14px; font-size:16px; cursor:pointer;">
      Login with EVE
    </button>
    <div>
      <div style="font-weight:600;">Статус:</div>
      <div id="status">не залогинен</div>
    </div>
  </div>

  <p style="margin-top:14px;">
    Версия: <span id="v"></span>
  </p>

    <!-- Кнопка выхода -->
    <button id="logoutBtn" style="margin-top: 20px;">Выход</button>
  </div>

<script>
const clientId = "4c2f7825780f4d0cba80a75d1a8a0c69";
const redirectUri = "https://instachad.github.io/test/";
const scopes = [
  "esi-wallet.read_character_wallet.v1",
  "esi-characters.read_standings.v1"
].join(" ");
let standingsRaw = [];      // оригинал из /standings
let standingsPretty = [];   // уже с именами (id + name + type + standing)

fetch("https://api.github.com/repos/instachad/test/commits?per_page=1")
  .then(r => r.json())
  .then(data => {
    const sha = data[0].sha.substring(0, 7);
    document.getElementById('v').textContent = "build " + sha;
  })
  .catch(() => {
    document.getElementById('v').textContent = "dev";
  });

const statusEl = document.getElementById('status');
const loginBtn = document.getElementById('loginBtn');
const loginContainer = document.getElementById('login-container');

// ---------- UI блок ----------
let appEl = document.getElementById('app');
if (!appEl) {
  appEl = document.createElement("div");
  appEl.id = "app";
  appEl.style.marginTop = "20px";
  appEl.style.display = "none";
  appEl.innerHTML = `
  <div style="padding:12px; border:1px solid #ddd; border-radius:12px; max-width:520px;">
    <div style="display:flex; justify-content:space-between;">
      <div><b>Рабочая зона</b></div>
      <button id="logoutBtn">Выход</button>
    </div>

    <div style="margin-top:10px;">
      <div><b>Персонаж:</b> <span id="charName">—</span></div>
      <div style="opacity:.6;">Character ID: <span id="charId">—</span></div>
    </div>

    <div style="margin-top:10px; opacity:.7;">
  Standings:
</div>

<div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
  <select id="corpSelect" style="padding:6px 10px; min-width:320px;">
    <option value="">Выберите NPC-корпорацию</option>
  </select>
  <button id="refreshStandingsBtn" style="padding:6px 10px; cursor:pointer;">Обновить</button>
</div>

<div id="barsContainer" style="margin-top:16px;"></div>

<pre id="standingsOut" style="margin-top:16px; padding:10px; background:#111; color:#ddd; border-radius:10px; max-width:520px; overflow:auto; font-size:12px; line-height:1.3; display:none;">—</pre>

  </div>
`;
  document.body.appendChild(appEl);
}

const logoutBtn = () => document.getElementById("logoutBtn");

function setUiLoggedIn(state) {
  if (state) {
    loginContainer.style.display = "none";
    appEl.style.display = "block";
    statusEl.textContent = "залогинен";
  } else {
    loginContainer.style.display = "flex";
    appEl.style.display = "none";
    statusEl.textContent = "не залогинен";
  }
}

// ---------- PKCE утилиты ----------
function base64UrlEncode(bytes) {
  let str = btoa(String.fromCharCode(...bytes));
  return str.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
}

async function sha256(input) {
  const data = new TextEncoder().encode(input);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return base64UrlEncode(new Uint8Array(hash));
}

function randomString(len = 64) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
  const arr = new Uint8Array(len);
  crypto.getRandomValues(arr);
  return Array.from(arr, x => chars[x % chars.length]).join("");
}

// ---------- ЛОГИН ----------
async function startLogin() {
  const state = randomString(24);
  const verifier = randomString(64);
  const challenge = await sha256(verifier);

  sessionStorage.setItem("eve_state", state);
  sessionStorage.setItem("eve_code_verifier", verifier);

  const authUrl =
    "https://login.eveonline.com/v2/oauth/authorize/?" +
    "response_type=code" +
    "&redirect_uri=" + encodeURIComponent(redirectUri) +
    "&client_id=" + encodeURIComponent(clientId) +
    "&scope=" + encodeURIComponent(scopes) +
    "&state=" + encodeURIComponent(state) +
    "&code_challenge=" + encodeURIComponent(challenge) +
    "&code_challenge_method=S256";

  window.location.href = authUrl;
}

loginBtn.addEventListener("click", startLogin);

// ---------- TOKEN EXCHANGE ----------
async function exchange(code) {
  const verifier = sessionStorage.getItem("eve_code_verifier");
  if (!verifier) throw new Error("no verifier");

  const body = new URLSearchParams();
  body.append("grant_type", "authorization_code");
  body.append("code", code);
  body.append("client_id", clientId);
  body.append("code_verifier", verifier);

  const resp = await fetch("https://login.eveonline.com/v2/oauth/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body.toString()
  });

  const data = await resp.json();
  if (!resp.ok) throw new Error(JSON.stringify(data));
  return data;
}

// ---------- CALLBACK ----------
(async function handleCallback() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const returnedState = params.get("state");

  if (!code) {
  const hasToken = !!localStorage.getItem("access_token");
  setUiLoggedIn(hasToken);
  if (hasToken) verifyToken();
  return;
}

  const expectedState = sessionStorage.getItem("eve_state");
  if (returnedState !== expectedState) {
    statusEl.textContent = "state mismatch";
    return;
  }

  statusEl.textContent = "получаю токен...";

  try {
    const token = await exchange(code);
    localStorage.setItem("access_token", token.access_token);
    localStorage.setItem("refresh_token", token.refresh_token);

    history.replaceState({}, document.title, redirectUri);
    setUiLoggedIn(true);
    verifyToken();
  } catch (e) {
    console.error(e);
    statusEl.textContent = "ошибка токена";
  }
})();

// ---------- VERIFY TOKEN ----------
async function verifyToken() {
  const token = localStorage.getItem("access_token");
  if (!token) return;

  const resp = await fetch("https://login.eveonline.com/oauth/verify", {
    headers: { "Authorization": "Bearer " + token }
  });

  if (!resp.ok) {
    console.log("verify failed", resp.status);
    return;
  }

  const data = await resp.json();

  document.getElementById("charName").textContent = data.CharacterName || "???";
  document.getElementById("charId").textContent = data.CharacterID || "???";

  localStorage.setItem("character_id", String(data.CharacterID || ""));
  fetchStandings();
}

async function fetchStandings() {
  const token = localStorage.getItem("access_token");
  const charId = localStorage.getItem("character_id");

  const bars = document.getElementById("barsContainer");
  if (!bars) return;

  if (!token || !charId) {
    bars.innerHTML = `<div style="opacity:.7;">Нет token или character_id. Сначала залогинься.</div>`;
    return;
  }

  bars.innerHTML = `<div style="opacity:.7;">Гружу standings...</div>`;

  const url = `https://esi.evetech.net/latest/characters/${encodeURIComponent(charId)}/standings/`;

  try {
    const resp = await fetch(url, { headers: { "Authorization": "Bearer " + token } });
    const text = await resp.text();

    if (!resp.ok) {
      bars.innerHTML = `<div style="color:#c66;">Ошибка ESI ${resp.status}<br><pre style="white-space:pre-wrap;">${text}</pre></div>`;
      return;
    }

    const data = JSON.parse(text);
    standingsRaw = data;

    const filtered = data.filter(x => x.from_type === "faction" || x.from_type === "npc_corp");
    const ids = Array.from(new Set(filtered.map(x => x.from_id)));

    const namesResp = await fetch("https://esi.evetech.net/latest/universe/names/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(ids)
    });

    const names = await namesResp.json();
    const idToName = new Map(names.map(x => [x.id, x.name]));

    standingsPretty = filtered.map(x => ({
      id: x.from_id,
      type: x.from_type,
      name: idToName.get(x.from_id) || String(x.from_id),
      standing: x.standing
    }));

    populateCorpSelect();
    bars.innerHTML = `<div style="opacity:.7;">Выбери корпорацию, чтобы увидеть полосы.</div>`;
  } catch (e) {
    console.error(e);
    bars.innerHTML = `<div style="color:#c66;">Ошибка запроса (см. консоль).</div>`;
  }
}

function populateCorpSelect() {
  const select = document.getElementById("corpSelect");
  if (!select) return;

  const corps = standingsPretty
    .filter(x => x.type === "npc_corp")
    .sort((a, b) => a.name.localeCompare(b.name));

  const prev = select.value;

  select.innerHTML = `<option value="">Выберите NPC-корпорацию</option>`;
  for (const c of corps) {
    const opt = document.createElement("option");
    opt.value = String(c.id);
    opt.textContent = c.name;
    select.appendChild(opt);
  }

  if (prev) select.value = prev;
}

async function renderBarsForCorpId(corpId) {
  const bars = document.getElementById("barsContainer");
  if (!bars) return;

  const corp = standingsPretty.find(x => x.type === "npc_corp" && String(x.id) === String(corpId));
  if (!corp) {
    bars.innerHTML = `<div style="opacity:.7;">Не нашёл эту корпорацию в standings.</div>`;
    return;
  }

  bars.innerHTML = "";

  // Узнаём faction_id корпы
  let faction = null;
  try {
    const resp = await fetch(`https://esi.evetech.net/latest/corporations/${corp.id}/`);
    if (resp.ok) {
      const corpData = await resp.json();
      if (corpData.faction_id) {
        faction = standingsPretty.find(x => x.type === "faction" && x.id === corpData.faction_id) || null;
      }
    }
  } catch (e) {}

  if (faction) {
    bars.appendChild(createBar(faction.name, faction.standing, "faction"));
  }
  bars.appendChild(createBar(corp.name, corp.standing, "corp"));
}

// временно простая полоса (красивую заменим потом)
function createBar(label, standing, kind) {
  const wrapper = document.createElement("div");
  wrapper.style.marginBottom = "16px";

  const title = document.createElement("div");
  title.textContent = `${label} (${standing.toFixed(2)})`;
  title.style.marginBottom = "6px";
  title.style.fontWeight = "600";

  const bar = document.createElement("div");
  bar.style.position = "relative";
  bar.style.height = "18px";
  bar.style.borderRadius = "6px";
  bar.style.overflow = "hidden";
  bar.style.background = "#262626";
  bar.style.boxShadow = "inset 0 0 0 1px rgba(255,255,255,0.06)";

  const center = document.createElement("div");
  center.style.position = "absolute";
  center.style.left = "50%";
  center.style.top = "0";
  center.style.height = "100%";
  center.style.width = "1px";
  center.style.background = "rgba(255,255,255,0.22)";
  bar.appendChild(center);

  const clamped = Math.max(-10, Math.min(10, standing));
  const percent = ((clamped + 10) / 20) * 100;

  const marker = document.createElement("div");
  marker.style.position = "absolute";
  marker.style.top = "0";
  marker.style.height = "100%";
  marker.style.width = "2px";
  marker.style.left = `${percent}%`;

  // простые цвета пока
  marker.style.background = clamped > 0 ? "#6e9c78" : clamped < 0 ? "#b37a4a" : "#888";
  bar.appendChild(marker);

  wrapper.appendChild(title);
  wrapper.appendChild(bar);
  return wrapper;
}

// ---------- FETCH STANDINGS ----------
async function fetchStandings() {
  const token = localStorage.getItem("access_token");
  const charId = localStorage.getItem("character_id");

  const out = document.getElementById("standingsOut");
  if (!out) return;

  if (!token || !charId) {
    out.textContent = "Нет token или character_id (сначала залогинься и дождись verify).";
    return;
  }

  out.textContent = "Гружу standings...";

  const url = `https://esi.evetech.net/latest/characters/${encodeURIComponent(charId)}/standings/`;

  try {
    const resp = await fetch(url, {
      headers: { "Authorization": "Bearer " + token }
    });

    const text = await resp.text(); // сначала текст, чтобы видеть ошибку как есть
    if (!resp.ok) {
      out.textContent = `Ошибка ESI ${resp.status}\n\n${text}`;
      return;
    }

    const data = JSON.parse(text);

// Берем только фракции и корпы
const filtered = data.filter(x =>
  x.from_type === "faction" || x.from_type === "npc_corp"
);

// Собираем список уникальных ID
const ids = Array.from(new Set(filtered.map(x => x.from_id)));

const namesResp = await fetch("https://esi.evetech.net/latest/universe/names/", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(ids)
});

const names = await namesResp.json();
const idToName = new Map(names.map(x => [x.id, x.name]));

const pretty = filtered.map(x => ({
  type: x.from_type,
  name: idToName.get(x.from_id) || String(x.from_id),
  standing: x.standing
}))
.sort((a, b) => a.type.localeCompare(b.type) || b.standing - a.standing);

out.textContent = JSON.stringify(pretty, null, 2);
  } catch (e) {
    console.error(e);
    out.textContent = "Ошибка запроса (см. консоль).";
  }
}

// ---------- LOGOUT ----------
document.addEventListener("click", e => {
  if (e.target && e.target.id === "logoutBtn") {
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    setUiLoggedIn(false);
  }
  if (e.target && e.target.id === "refreshStandingsBtn") {
  fetchStandings();
}
});
document.addEventListener("change", e => {
  if (e.target && e.target.id === "corpSelect") {
    const corpId = e.target.value;
    if (corpId) renderBarsForCorpId(corpId);
  }
});
</script>
</body>
</html>
