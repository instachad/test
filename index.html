<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EVE Tracker</title>
</head>
<body>
  <h1>EVE Tracker</h1> 

  <!-- Страница авторизации -->
  <div style="display:flex; gap:12px; align-items:center; padding:12px; border:1px solid #ddd; border-radius:12px; max-width:520px;" id="login-container">
    <button id="loginBtn" style="padding:10px 14px; font-size:16px; cursor:pointer;">
      Login with EVE
    </button>
    <div>
      <div style="font-weight:600;">Статус:</div>
      <div id="status">не залогинен</div>
    </div>
  </div>

  <p style="margin-top:14px;">
    Версия: <span id="v"></span>
  </p>

    <!-- Кнопка выхода -->
    <button id="logoutBtn" style="margin-top: 20px;">Выход</button>
  </div>

<script>
const clientId = "4c2f7825780f4d0cba80a75d1a8a0c69";
const redirectUri = "https://instachad.github.io/test/";

const scopes = [
  "esi-wallet.read_character_wallet.v1",
  "esi-characters.read_standings.v1"
].join(" ");

fetch("https://api.github.com/repos/instachad/test/commits?per_page=1")
  .then(r => r.json())
  .then(data => {
    const sha = data[0].sha.substring(0, 7);
    document.getElementById('v').textContent = "build " + sha;
  })
  .catch(() => {
    document.getElementById('v').textContent = "dev";
  });

const statusEl = document.getElementById('status');
const loginBtn = document.getElementById('loginBtn');
const loginContainer = document.getElementById('login-container');

// ---------- UI блок ----------
let appEl = document.getElementById('app');
if (!appEl) {
  appEl = document.createElement("div");
  appEl.id = "app";
  appEl.style.marginTop = "20px";
  appEl.style.display = "none";
  appEl.innerHTML = `
  <div style="padding:12px; border:1px solid #ddd; border-radius:12px; max-width:520px;">
    <div style="display:flex; justify-content:space-between;">
      <div><b>Рабочая зона</b></div>
      <button id="logoutBtn">Выход</button>
    </div>

    <div style="margin-top:10px;">
      <div><b>Персонаж:</b> <span id="charName">—</span></div>
      <div style="opacity:.6;">Character ID: <span id="charId">—</span></div>
    </div>

    <div style="margin-top:10px; opacity:.7;">
  Standings (сырой вывод):
</div>
<pre id="standingsOut" style="margin-top:8px; padding:10px; background:#111; color:#ddd; border-radius:10px; max-width:520px; overflow:auto; font-size:12px; line-height:1.3;">—</pre>
<button id="refreshStandingsBtn" style="margin-top:10px; padding:8px 12px; cursor:pointer;">Обновить standings</button>
  </div>
`;
  document.body.appendChild(appEl);
}

const logoutBtn = () => document.getElementById("logoutBtn");

function setUiLoggedIn(state) {
  if (state) {
    loginContainer.style.display = "none";
    appEl.style.display = "block";
    statusEl.textContent = "залогинен";
  } else {
    loginContainer.style.display = "flex";
    appEl.style.display = "none";
    statusEl.textContent = "не залогинен";
  }
}

// ---------- PKCE утилиты ----------
function base64UrlEncode(bytes) {
  let str = btoa(String.fromCharCode(...bytes));
  return str.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
}

async function sha256(input) {
  const data = new TextEncoder().encode(input);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return base64UrlEncode(new Uint8Array(hash));
}

function randomString(len = 64) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
  const arr = new Uint8Array(len);
  crypto.getRandomValues(arr);
  return Array.from(arr, x => chars[x % chars.length]).join("");
}

// ---------- ЛОГИН ----------
async function startLogin() {
  const state = randomString(24);
  const verifier = randomString(64);
  const challenge = await sha256(verifier);

  sessionStorage.setItem("eve_state", state);
  sessionStorage.setItem("eve_code_verifier", verifier);

  const authUrl =
    "https://login.eveonline.com/v2/oauth/authorize/?" +
    "response_type=code" +
    "&redirect_uri=" + encodeURIComponent(redirectUri) +
    "&client_id=" + encodeURIComponent(clientId) +
    "&scope=" + encodeURIComponent(scopes) +
    "&state=" + encodeURIComponent(state) +
    "&code_challenge=" + encodeURIComponent(challenge) +
    "&code_challenge_method=S256";

  window.location.href = authUrl;
}

loginBtn.addEventListener("click", startLogin);

// ---------- TOKEN EXCHANGE ----------
async function exchange(code) {
  const verifier = sessionStorage.getItem("eve_code_verifier");
  if (!verifier) throw new Error("no verifier");

  const body = new URLSearchParams();
  body.append("grant_type", "authorization_code");
  body.append("code", code);
  body.append("client_id", clientId);
  body.append("code_verifier", verifier);

  const resp = await fetch("https://login.eveonline.com/v2/oauth/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body.toString()
  });

  const data = await resp.json();
  if (!resp.ok) throw new Error(JSON.stringify(data));
  return data;
}

// ---------- CALLBACK ----------
(async function handleCallback() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const returnedState = params.get("state");

  if (!code) {
  const hasToken = !!localStorage.getItem("access_token");
  setUiLoggedIn(hasToken);
  if (hasToken) verifyToken();
  return;
}

  const expectedState = sessionStorage.getItem("eve_state");
  if (returnedState !== expectedState) {
    statusEl.textContent = "state mismatch";
    return;
  }

  statusEl.textContent = "получаю токен...";

  try {
    const token = await exchange(code);
    localStorage.setItem("access_token", token.access_token);
    localStorage.setItem("refresh_token", token.refresh_token);

    history.replaceState({}, document.title, redirectUri);
    setUiLoggedIn(true);
    verifyToken();
  } catch (e) {
    console.error(e);
    statusEl.textContent = "ошибка токена";
  }
})();

// ---------- VERIFY TOKEN ----------
async function verifyToken() {
  const token = localStorage.getItem("access_token");
  if (!token) return;

  const resp = await fetch("https://login.eveonline.com/oauth/verify", {
    headers: { "Authorization": "Bearer " + token }
  });

  if (!resp.ok) {
    console.log("verify failed", resp.status);
    return;
  }

  const data = await resp.json();

  document.getElementById("charName").textContent = data.CharacterName || "???";
  document.getElementById("charId").textContent = data.CharacterID || "???";

  localStorage.setItem("character_id", String(data.CharacterID || ""));
}
// ---------- LOGOUT ----------
document.addEventListener("click", e => {
  if (e.target && e.target.id === "logoutBtn") {
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    setUiLoggedIn(false);
  }
});
</script>
</body>
</html>
