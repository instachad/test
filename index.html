<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EVE Tracker</title>
  <style>
    body {
      margin: 0;
      padding: 24px;
      background: #0f1115;
      color: #d6d9df;
      font-family: "Segoe UI", Roboto, sans-serif;
    }

    h1 {
      font-weight: 600;
      letter-spacing: 0.5px;
      color: #e4e8f0;
    }

    .panel {
      padding: 16px;
      max-width: 520px;
      background: #171a21;
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 2px;
    }

    #login-container {
      background: #171a21;
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 2px;
    }

    button {
      background: linear-gradient(180deg, #2a3142 0%, #222733 100%);
      color: #d6d9df;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 2px;
      padding: 8px 14px;
      cursor: pointer;
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, 0.05),
        0 1px 2px rgba(0, 0, 0, 0.6);
      transition: all 120ms ease;
    }

    button:hover {
      background: linear-gradient(180deg, #313a4f 0%, #252c3b 100%);
      border-color: rgba(255, 255, 255, 0.18);
    }

    button:active {
      transform: translateY(1px);
      box-shadow:
        inset 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    select {
      background: #1e2330;
      color: #d6d9df;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 2px;
    }

    select:focus,
    button:focus {
      outline: none;
      border-color: #4a6fa5;
    }

    #barsContainer {
      margin-top: 16px;
    }

    /* ===== UI: layout ===== */
    .grid {
      display: grid;
      gap: 12px;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .muted {
      opacity: .75;
    }

    .small {
      font-size: 12px;
      opacity: .8;
    }

    .kpi {
      display: flex;
      gap: 10px;
      align-items: baseline;
    }

    .kpi .val {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: .2px;
    }

    .kpi .lbl {
      font-size: 12px;
      opacity: .8;
    }

    /* ===== UI: sections ===== */
    .section {
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(255, 255, 255, 0.02);
      border-radius: 2px;
    }

    .section h3 {
      margin: 0 0 10px 0;
      font-size: 13px;
      letter-spacing: .6px;
      text-transform: uppercase;
      opacity: .9;
    }

    /* ===== UI: standing bars ===== */
    .barBlock {
      margin-top: 10px;
    }

    .barTitle {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .barTitle .name {
      opacity: .95;
    }

    .barTitle .num {
      opacity: .75;
      font-variant-numeric: tabular-nums;
    }

    .bar {
      position: relative;
      height: 18px;
      background: #151821;
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 2px;
      overflow: hidden;
    }

    .bar .ticks {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        linear-gradient(to right, rgba(255, 255, 255, 0.08) 0 1px, transparent 1px 100%) 0 0 / 10% 100%;
      opacity: .35;
    }

    .bar .zero {
      position: absolute;
      left: 50%;
      top: 0;
      width: 1px;
      height: 100%;
      background: rgba(255, 255, 255, 0.28);
    }

    .bar .fill {
      position: absolute;
      top: 0;
      height: 100%;
      opacity: .85;
    }

    .bar .marker {
      position: absolute;
      top: 0;
      width: 2px;
      height: 100%;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.35);
      opacity: .95;
    }

    /* faction colors */
    .bar.faction .fill.pos {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.08), #5b7ea6);
    }

    .bar.faction .fill.neg {
      background: linear-gradient(90deg, #a66a75, rgba(255, 255, 255, 0.08));
    }

    .bar.faction .marker.pos {
      background: #5b7ea6;
    }

    .bar.faction .marker.neg {
      background: #a66a75;
    }

    .bar.faction .marker.zero {
      background: #888;
    }

    /* corp colors */
    .bar.corp .fill.pos {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.08), #6e9c78);
    }

    .bar.corp .fill.neg {
      background: linear-gradient(90deg, #b37a4a, rgba(255, 255, 255, 0.08));
    }

    .bar.corp .marker.pos {
      background: #6e9c78;
    }

    .bar.corp .marker.neg {
      background: #b37a4a;
    }

    .bar.corp .marker.zero {
      background: #888;
    }

    /* ===== UI: progress (storyline / epic) ===== */
    .progressWrap {
      margin-top: 8px;
    }

    .progressTop {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      opacity: .85;
      margin-bottom: 6px;
    }

    .progress {
      height: 10px;
      background: #151821;
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress>div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.10), rgba(91, 126, 166, 0.85));
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border: 1px solid rgba(255, 255, 255, 0.10);
      border-radius: 2px;
      font-size: 12px;
      opacity: .9;
    }

    .badge.ok {
      border-color: rgba(110, 156, 120, 0.45);
    }

    .badge.warn {
      border-color: rgba(179, 122, 74, 0.55);
    }

    .badge.bad {
      border-color: rgba(166, 106, 117, 0.55);
    }

    input[type="number"],
    input[type="datetime-local"] {
      background: #1e2330;
      color: #d6d9df;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 2px;
      padding: 7px 10px;
    }
  </style>

</head>

<body>
  <h1>EVE Tracker</h1>

  <!-- Страница авторизации -->
  <div id="login-container" class="panel" style="display:flex; gap:12px; align-items:center;">
    <button id="loginBtn">
      Login with EVE
    </button>

    <div>
      <div style="font-weight:600;">Статус:</div>
      <div id="status">не залогинен</div>
    </div>
  </div>

  <p style="margin-top:14px;">
    Версия: <span id="v"></span>
  </p>

  <script>

    /* ======== CONFIG / STATE ========*/

    const clientId = "4c2f7825780f4d0cba80a75d1a8a0c69";
    const redirectUri = "https://instachad.github.io/test/";
    const scopes = [
      "esi-wallet.read_character_wallet.v1",
      "esi-characters.read_standings.v1"
    ].join(" ");

    let standingsRaw = [];
    let standingsPretty = [];
    const nameCache = new Map();

    // ===== AUTH MINIMAL (нужно чтобы работало refresh/esiFetchJson/logout) =====
    const LS = {
      access: "access_token",
      refresh: "refresh_token",
      expiresAt: "access_expires_at"
    };

    function getRefreshToken() {
      return localStorage.getItem(LS.refresh);
    }

    function storeTokens(t) {
      localStorage.setItem(LS.access, t.access_token);
      if (t.refresh_token) localStorage.setItem(LS.refresh, t.refresh_token);
      const expAt = Date.now() + (Number(t.expires_in || 0) * 1000) - 30000;
      localStorage.setItem(LS.expiresAt, String(expAt));
    }

    function logout(reason = "") {
      localStorage.removeItem(LS.access);
      localStorage.removeItem(LS.refresh);
      localStorage.removeItem(LS.expiresAt);
      localStorage.removeItem("character_id");
      setUiLoggedIn(false);
      if (reason) console.warn("Logout:", reason);
    }

    let refreshInFlight = null;

    async function refreshAccessToken() {
      if (refreshInFlight) return refreshInFlight;

      refreshInFlight = (async () => {
        const rt = localStorage.getItem(LS.refresh);
        if (!rt) throw new Error("Not logged in");

        const body = new URLSearchParams();
        body.append("grant_type", "refresh_token");
        body.append("refresh_token", rt);
        body.append("client_id", clientId);

        const res = await fetch("https://login.eveonline.com/v2/oauth/token", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: body.toString()
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(`Refresh failed: ${res.status} ${txt}`);
        }

        const json = await res.json();
        storeTokens(json);
        return json.access_token;
      })();

      try {
        return await refreshInFlight;
      } finally {
        refreshInFlight = null;
      }
    }

    async function ensureValidAccessToken() {
      const token = localStorage.getItem(LS.access);
      const expAt = Number(localStorage.getItem(LS.expiresAt) || "0");

      if (!token || !expAt || Date.now() >= expAt) {
        return await refreshAccessToken();
      }
      return token;
    }

    async function esiFetchJson(url, options = {}) {
      const doReq = async (accessToken) => {
        const headers = new Headers(options.headers || {});
        headers.set("Authorization", `Bearer ${accessToken}`);
        return fetch(url, { ...options, headers });
      };

      let token = await ensureValidAccessToken();
      let res = await doReq(token);

      if (res.status === 401) {
        token = await refreshAccessToken();
        res = await doReq(token);
      }

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`ESI ${res.status}: ${txt}`);
      }

      return res.json();
    }

    /* ======== VERSION (build SHA) ======== */

    fetch("https://api.github.com/repos/instachad/test/commits?per_page=1")
      .then(r => r.json())
      .then(data => {
        const sha = data[0].sha.substring(0, 7);
        document.getElementById('v').textContent = "build " + sha;
      })
      .catch(() => {
        document.getElementById('v').textContent = "dev";
      });

    /* ======== BASIC UI ELEMENTS ======== */

    const statusEl = document.getElementById('status');
    const loginBtn = document.getElementById('loginBtn');
    const loginContainer = document.getElementById('login-container');

    let appEl = document.createElement("div");
    appEl.id = "app";
    appEl.style.marginTop = "20px";
    appEl.style.display = "none";

    appEl.innerHTML = `
<div class="panel">
  <div class="row">
    <div><b>Рабочая зона</b></div>
    <button id="logoutBtn">Выход</button>
  </div>

  <div style="margin-top:10px;">
    <div><b>Персонаж:</b> <span id="charName">Test Capsuleer</span></div>
    <div class="small">Character ID: <span id="charId">123456789</span></div>
  </div>

  <div class="grid" style="margin-top:12px;">

    <!-- ===== Standings ===== -->
    <div class="section">
      <h3>Standings</h3>

      <div class="row" style="align-items:flex-end;">
        <div style="flex:1;">
          <div class="small">NPC корпорация</div>
          <select id="corpSelect" style="min-width:320px; width:100%; margin-top:6px;">
            <option value="1000035">Caldari Navy (пример)</option>
            <option value="1000002">Kaalakiota Corporation (пример)</option>
          </select>
        </div>

        <div style="display:flex; gap:8px;">
          <button id="refreshStandingsBtn">Обновить</button>
        </div>
      </div>

      <div id="barsContainer" style="margin-top:14px;">

        <!-- FAKE: faction bar -->
        <div class="barBlock">
          <div class="barTitle">
            <div class="name">Caldari State</div>
            <div class="num">+6.42</div>
          </div>

          <div class="bar faction">
            <div class="ticks"></div>
            <div class="zero"></div>

            <!-- fill from center to value -->
            <div class="fill pos" style="left:50%; width:32.1%;"></div>
            <!-- marker at value -->
            <div class="marker pos" style="left:82.1%;"></div>
          </div>
        </div>

        <!-- FAKE: corp bar -->
        <div class="barBlock">
          <div class="barTitle">
            <div class="name">Caldari Navy</div>
            <div class="num">-2.10</div>
          </div>

          <div class="bar corp">
            <div class="ticks"></div>
            <div class="zero"></div>

            <div class="fill neg" style="left:39.5%; width:10.5%;"></div>
            <div class="marker neg" style="left:39.5%;"></div>
          </div>
        </div>

        <div class="small muted" style="margin-top:10px;">
          Сейчас это пример. Потом эти цифры и полосы будут строиться из ESI.
        </div>

      </div>
    </div>

    <!-- ===== Storyline tracker ===== -->
    <div class="section">
      <h3>Storyline</h3>

      <div class="row">
        <div class="kpi">
          <div class="val" id="storyDone">11</div>
          <div class="lbl">из <span id="storyNeed">16</span> миссий</div>
        </div>
        <span class="badge warn" id="storyBadge">осталось 5</span>
      </div>

      <div class="progressWrap">
        <div class="progressTop">
          <div class="muted">Прогресс до следующей storyline</div>
          <div class="muted"><span id="storyPct">68</span>%</div>
        </div>
        <div class="progress"><div style="width:68%;"></div></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div style="flex:1;">
          <div class="small">Счётчик миссий (ручной ввод, пока не прикрутили wallet-логику)</div>
          <div class="row" style="justify-content:flex-start; margin-top:6px;">
            <button id="storyPlus">+1 миссия</button>
            <button id="storyReset">сбросить</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Epic arc tracker ===== -->
    <div class="section">
      <h3>Epic arc</h3>

      <div class="row">
        <div>
          <div class="small muted">Последнее завершение</div>
          <div style="font-weight:600;" id="epicLast">2026-01-10</div>
        </div>
        <div>
          <div class="small muted">Следующий доступ</div>
          <div style="font-weight:700;" id="epicNext">2026-04-10</div>
        </div>
        <span class="badge ok" id="epicBadge">не скоро</span>
      </div>

      <div class="progressWrap">
        <div class="progressTop">
          <div class="muted">Кулдаун</div>
          <div class="muted"><span id="epicLeft">50</span> дней осталось</div>
        </div>
        <div class="progress"><div style="width:45%; background:linear-gradient(90deg, rgba(255,255,255,0.10), rgba(110,156,120,0.85));"></div></div>
      </div>

      <div class="row" style="margin-top:10px; align-items:flex-end;">
        <div style="flex:1;">
          <div class="small">Установить дату последнего завершения (пока вручную)</div>
          <input id="epicLastInput" type="date" style="margin-top:6px; width:100%;">
        </div>
        <button id="epicApply">применить</button>
      </div>

      <div class="small muted" style="margin-top:8px;">
        Потом сделаем список эпик-арок и их разные кулдауны, если надо.
      </div>
    </div>

  </div>
</div>
`;

    document.body.appendChild(appEl);

    function setUiLoggedIn(state) {
      loginContainer.style.display = state ? "none" : "flex";
      appEl.style.display = state ? "block" : "none";
      statusEl.textContent = state ? "залогинен" : "не залогинен";
    }

    /* ======== PKCE UTILS ======== */

    function base64UrlEncode(bytes) {
      return btoa(String.fromCharCode(...bytes))
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/g, "");
    }

    async function sha256(input) {
      const data = new TextEncoder().encode(input);
      const hash = await crypto.subtle.digest("SHA-256", data);
      return base64UrlEncode(new Uint8Array(hash));
    }

    function randomString(len = 64) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
      const arr = new Uint8Array(len);
      crypto.getRandomValues(arr);
      return Array.from(arr, x => chars[x % chars.length]).join("");
    }

    /* ======== LOGIN ======== */

    async function startLogin() {
      const state = randomString(24);
      const verifier = randomString(64);
      const challenge = await sha256(verifier);

      sessionStorage.setItem("eve_state", state);
      sessionStorage.setItem("eve_code_verifier", verifier);

      const authUrl =
        "https://login.eveonline.com/v2/oauth/authorize/?" +
        "response_type=code" +
        "&redirect_uri=" + encodeURIComponent(redirectUri) +
        "&client_id=" + encodeURIComponent(clientId) +
        "&scope=" + encodeURIComponent(scopes) +
        "&state=" + encodeURIComponent(state) +
        "&code_challenge=" + encodeURIComponent(challenge) +
        "&code_challenge_method=S256";

      window.location.href = authUrl;
    }

    loginBtn.addEventListener("click", startLogin);

    /* ======== TOKEN EXCHANGE ======== */

    async function exchange(code) {
      const verifier = sessionStorage.getItem("eve_code_verifier");
      if (!verifier) throw new Error("Missing PKCE verifier");

      const body = new URLSearchParams();
      body.append("grant_type", "authorization_code");
      body.append("code", code);
      body.append("client_id", clientId);
      body.append("code_verifier", verifier);

      const resp = await fetch("https://login.eveonline.com/v2/oauth/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body.toString()
      });

      const data = await resp.json();
      if (!resp.ok) throw new Error(JSON.stringify(data));
      return data;
    }

    /* ======== CALLBACK HANDLER ======== */

    (async function handleCallback() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      const returnedState = params.get("state");

      if (!code) {
        const hasRefresh = !!getRefreshToken();
        setUiLoggedIn(hasRefresh);

        if (hasRefresh) {
          try {
            await verifyToken();
          } catch (e) {
            console.warn(e);
            logout("session invalid");
          }
        }
        return;

      }

      const expectedState = sessionStorage.getItem("eve_state");
      if (returnedState !== expectedState) {
        statusEl.textContent = "state mismatch";
        return;
      }

      try {
        const token = await exchange(code);
        storeTokens(token);
        history.replaceState({}, document.title, redirectUri);
        setUiLoggedIn(true);
        await verifyToken();
      } catch (e) {
        console.error(e);
        statusEl.textContent = "ошибка токена";
      }
    })();

    /* ======== VERIFY TOKEN ======== */

    async function verifyToken() {
      let token;
      try {
        token = await ensureValidAccessToken();
      } catch (e) {
        logout("no valid token");
        return;
      }

      let resp = await fetch("https://login.eveonline.com/oauth/verify", {
        headers: { "Authorization": "Bearer " + token }
      });

      if (!resp.ok) {
        try {
          token = await refreshAccessToken();
          resp = await fetch("https://login.eveonline.com/oauth/verify", {
            headers: { "Authorization": "Bearer " + token }
          });
          if (!resp.ok) {
            logout("verify failed");
            return;
          }
        } catch (e) {
          logout("verify failed");
          return;
        }
      }

      const data = await resp.json();

      document.getElementById("charName").textContent = data.CharacterName || "???";
      document.getElementById("charId").textContent = data.CharacterID || "???";
      localStorage.setItem("character_id", String(data.CharacterID || ""));

      fetchStandings();
    }


    /* ======== FETCH STANDINGS ======== */

    async function fetchStandings() {
      const charId = localStorage.getItem("character_id");
      const bars = document.getElementById("barsContainer");
      if (!charId) return;

      bars.innerHTML = "Гружу standings...";

      let data;
      try {
        data = await esiFetchJson(
          `https://esi.evetech.net/latest/characters/${charId}/standings/`,
          {
            headers: {
              "Cache-Control": "no-cache"
            }
          }
        );
      } catch (e) {
        console.error(e);
        bars.innerHTML = "Ошибка загрузки standings (возможно, сессия умерла)";
        // если refresh умер, esiFetchJson кинет ошибку на refresh, тогда вылогиниваем
        if (String(e.message || e).includes("Refresh failed") || String(e.message || e).includes("Not logged in")) {
          logout("standings auth failed");
        }
        return;
      }

      standingsRaw = data;
      console.log("ESI standings raw", data);

      const filtered = data.filter(x =>
        x.from_type === "faction" || x.from_type === "npc_corp"
      );

      const ids = [...new Set(filtered.map(x => x.from_id))];

      const names = await publicFetchJson(
        "https://esi.evetech.net/latest/universe/names/",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(ids)
        }
      );

      const idToName = new Map(names.map(x => [x.id, x.name]));
      idToName.forEach((name, id) => nameCache.set(id, name));

      standingsPretty = filtered.map(x => ({
        id: x.from_id,
        type: x.from_type,
        name: idToName.get(x.from_id) || String(x.from_id),
        standing: x.standing
      }));

      populateCorpSelect();
      bars.innerHTML = "Выбери корпорацию.";
    }
    /* ======== HELPER ======== */

    async function publicFetchJson(url, options = {}) {
      const res = await fetch(url, options);

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`HTTP ${res.status}: ${txt}`);
      }

      return res.json();
    }

    /* ======== SELECT + RENDER ======== */

    function populateCorpSelect() {
      const select = document.getElementById("corpSelect");
      select.innerHTML = `<option value="">Выберите NPC-корпорацию</option>`;

      standingsPretty
        .filter(x => x.type === "npc_corp")
        .sort((a, b) => a.name.localeCompare(b.name))
        .forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.name;
          select.appendChild(opt);
        });
    }

    async function renderBarsForCorpId(corpId) {
      const bars = document.getElementById("barsContainer");
      bars.innerHTML = "";

      const corp = standingsPretty.find(x =>
        x.type === "npc_corp" && String(x.id) === String(corpId)
      );
      if (!corp) return;

      let faction = null;

      try {
        const resp = await fetch(`https://esi.evetech.net/latest/corporations/${corp.id}/`);
        if (resp.ok) {
          const corpData = await resp.json();
          if (corpData.faction_id) {
            const fid = corpData.faction_id;

            faction =
              standingsPretty.find(x => x.type === "faction" && x.id === fid) ||
              { id: fid, type: "faction", name: nameCache.get(fid) || "Faction", standing: 0 };
          }
        }
      } catch { }

      if (faction) bars.appendChild(createBar(faction.name, faction.standing, "faction"));
      bars.appendChild(createBar(corp.name, corp.standing, "corp"));
    }

    /* ======== BAR RENDER ======== */

    function createBar(label, standing, kind) {
      const wrapper = document.createElement("div");
      wrapper.style.marginBottom = "16px";

      const title = document.createElement("div");
      title.textContent = `${label} (${standing.toFixed(2)})`;
      title.style.marginBottom = "6px";
      title.style.fontWeight = "600";

      const bar = document.createElement("div");
      bar.style.position = "relative";
      bar.style.height = "18px";
      bar.style.background = "#262626";
      bar.style.borderRadius = "2px";

      const percent = ((Math.max(-10, Math.min(10, standing)) + 10) / 20) * 100;

      const marker = document.createElement("div");
      marker.style.position = "absolute";
      marker.style.left = `${percent}%`;
      marker.style.width = "2px";
      marker.style.height = "100%";
      marker.style.background = kind === "faction" ? "#5b7ea6" : "#6e9c78";

      bar.appendChild(marker);
      wrapper.appendChild(title);
      wrapper.appendChild(bar);

      return wrapper;
    }

    /* ======== EVENTS ======== */

    document.addEventListener("click", e => {
      if (e.target.id === "logoutBtn") {
        logout("manual");

      }
      if (e.target.id === "refreshStandingsBtn") {
        fetchStandings();
      }
      if (e.target.id === "storyPlus") {
        const doneEl = document.getElementById("storyDone");
        const needEl = document.getElementById("storyNeed");
        let done = parseInt(doneEl.textContent, 10) || 0;
        const need = parseInt(needEl.textContent, 10) || 16;
        done = Math.min(need, done + 1);
        doneEl.textContent = String(done);

        const left = Math.max(0, need - done);
        document.getElementById("storyBadge").textContent = left === 0 ? "готово" : `осталось ${left}`;
        document.getElementById("storyBadge").className = "badge " + (left === 0 ? "ok" : left <= 3 ? "warn" : "bad");
        const pct = Math.round((done / need) * 100);
        document.getElementById("storyPct").textContent = String(pct);
        document.querySelector(".section .progress > div").style.width = pct + "%";
      }

      if (e.target.id === "storyReset") {
        document.getElementById("storyDone").textContent = "0";
        document.getElementById("storyPct").textContent = "0";
        document.getElementById("storyBadge").textContent = "осталось 16";
        document.getElementById("storyBadge").className = "badge bad";
        document.querySelector(".section .progress > div").style.width = "0%";
      }

      if (e.target.id === "epicApply") {
        const inp = document.getElementById("epicLastInput");
        if (!inp || !inp.value) return;
        const last = new Date(inp.value + "T00:00:00");
        const next = new Date(last);
        next.setDate(next.getDate() + 90); // пример: 90 дней кулдаун, потом настроим как надо

        const fmt = d => d.toISOString().slice(0, 10);
        document.getElementById("epicLast").textContent = fmt(last);
        document.getElementById("epicNext").textContent = fmt(next);

        const now = new Date();
        const leftDays = Math.ceil((next - now) / (1000 * 60 * 60 * 24));
        document.getElementById("epicLeft").textContent = String(Math.max(0, leftDays));

        const badge = document.getElementById("epicBadge");
        if (leftDays <= 0) {
          badge.textContent = "доступно";
          badge.className = "badge ok";
        } else if (leftDays <= 7) {
          badge.textContent = "скоро";
          badge.className = "badge warn";
        } else {
          badge.textContent = "не скоро";
          badge.className = "badge bad";
        }
      }
    });

    document.addEventListener("change", e => {
      if (e.target.id === "corpSelect") {
        renderBarsForCorpId(e.target.value);
      }
    });

  </script>
</body>

</html>