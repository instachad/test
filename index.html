<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EVE Tracker</title>
  <style>
  body {
    margin: 0;
    padding: 24px;
    background: #0f1115;
    color: #d6d9df;
    font-family: "Segoe UI", Roboto, sans-serif;
  }

  h1 {
    font-weight: 600;
    letter-spacing: 0.5px;
    color: #e4e8f0;
  }

  #login-container,
#app > div {
  background: #171a21;
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 2px; /* было 12px */
}

  button {
  background: #222733;
  color: #d6d9df;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 2px; /* было 6px */
}

  button:hover {
    background: #2a3142;
    border-color: rgba(255,255,255,0.15);
  }

  select {
  background: #1e2330;
  color: #d6d9df;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 2px;
}

  select:focus,
  button:focus {
    outline: none;
    border-color: #4a6fa5;
  }

  #barsContainer {
    margin-top: 16px;
  }
</style>

</head>
<body>
  <h1>EVE Tracker</h1> 

  <!-- Страница авторизации -->
  <div style="display:flex; gap:12px; align-items:center; padding:12px; border:1px solid #ddd; border-radius:12px; max-width:520px;" id="login-container">
    <button id="loginBtn" style="padding:10px 14px; font-size:16px; cursor:pointer;">
      Login with EVE
    </button>
    <div>
      <div style="font-weight:600;">Статус:</div>
      <div id="status">не залогинен</div>
    </div>
  </div>

  <p style="margin-top:14px;">
    Версия: <span id="v"></span>
  </p>
 
<script>

/* ======== CONFIG / STATE ========*/

const clientId = "4c2f7825780f4d0cba80a75d1a8a0c69";
const redirectUri = "https://instachad.github.io/test/";
const scopes = [
  "esi-wallet.read_character_wallet.v1",
  "esi-characters.read_standings.v1"
].join(" ");

let standingsRaw = [];
let standingsPretty = [];
const nameCache = new Map();

/* ======== VERSION (build SHA) ======== */

fetch("https://api.github.com/repos/instachad/test/commits?per_page=1")
  .then(r => r.json())
  .then(data => {
    const sha = data[0].sha.substring(0, 7);
    document.getElementById('v').textContent = "build " + sha;
  })
  .catch(() => {
    document.getElementById('v').textContent = "dev";
  });

/* ======== BASIC UI ELEMENTS ======== */

const statusEl = document.getElementById('status');
const loginBtn = document.getElementById('loginBtn');
const loginContainer = document.getElementById('login-container');

let appEl = document.createElement("div");
appEl.id = "app";
appEl.style.marginTop = "20px";
appEl.style.display = "none";

appEl.innerHTML = `
<div style="padding:12px; border:1px solid #ddd; border-radius:12px; max-width:520px;">
  <div style="display:flex; justify-content:space-between;">
    <div><b>Рабочая зона</b></div>
    <button id="logoutBtn">Выход</button>
  </div>

  <div style="margin-top:10px;">
    <div><b>Персонаж:</b> <span id="charName">—</span></div>
    <div style="opacity:.6;">Character ID: <span id="charId">—</span></div>
  </div>

  <div style="margin-top:10px; opacity:.7;">Standings:</div>

  <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
    <select id="corpSelect" style="padding:6px 10px; min-width:320px;">
      <option value="">Выберите NPC-корпорацию</option>
    </select>
    <button id="refreshStandingsBtn" style="padding:6px 10px; cursor:pointer;">Обновить</button>
  </div>

  <div id="barsContainer" style="margin-top:16px;"></div>
</div>
`;

document.body.appendChild(appEl);

function setUiLoggedIn(state) {
  loginContainer.style.display = state ? "none" : "flex";
  appEl.style.display = state ? "block" : "none";
  statusEl.textContent = state ? "залогинен" : "не залогинен";
}

/* ======== PKCE UTILS ======== */

function base64UrlEncode(bytes) {
  return btoa(String.fromCharCode(...bytes))
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=+$/g, "");
}

async function sha256(input) {
  const data = new TextEncoder().encode(input);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return base64UrlEncode(new Uint8Array(hash));
}

function randomString(len = 64) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
  const arr = new Uint8Array(len);
  crypto.getRandomValues(arr);
  return Array.from(arr, x => chars[x % chars.length]).join("");
}

/* ======== LOGIN ======== */

async function startLogin() {
  const state = randomString(24);
  const verifier = randomString(64);
  const challenge = await sha256(verifier);

  sessionStorage.setItem("eve_state", state);
  sessionStorage.setItem("eve_code_verifier", verifier);

  const authUrl =
    "https://login.eveonline.com/v2/oauth/authorize/?" +
    "response_type=code" +
    "&redirect_uri=" + encodeURIComponent(redirectUri) +
    "&client_id=" + encodeURIComponent(clientId) +
    "&scope=" + encodeURIComponent(scopes) +
    "&state=" + encodeURIComponent(state) +
    "&code_challenge=" + encodeURIComponent(challenge) +
    "&code_challenge_method=S256";

  window.location.href = authUrl;
}

loginBtn.addEventListener("click", startLogin);

/* ======== TOKEN EXCHANGE ======== */

async function exchange(code) {
  const verifier = sessionStorage.getItem("eve_code_verifier");
  if (!verifier) throw new Error("Missing PKCE verifier");

  const body = new URLSearchParams();
  body.append("grant_type", "authorization_code");
  body.append("code", code);
  body.append("client_id", clientId);
  body.append("code_verifier", verifier);

  const resp = await fetch("https://login.eveonline.com/v2/oauth/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body.toString()
  });

  const data = await resp.json();
  if (!resp.ok) throw new Error(JSON.stringify(data));
  return data;
}

/* ======== CALLBACK HANDLER ======== */

(async function handleCallback() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const returnedState = params.get("state");

  if (!code) {
    const hasToken = !!localStorage.getItem("access_token");
    setUiLoggedIn(hasToken);
    if (hasToken) verifyToken();
    return;
  }

  const expectedState = sessionStorage.getItem("eve_state");
  if (returnedState !== expectedState) {
    statusEl.textContent = "state mismatch";
    return;
  }

  try {
    const token = await exchange(code);
    localStorage.setItem("access_token", token.access_token);
    localStorage.setItem("refresh_token", token.refresh_token);

    history.replaceState({}, document.title, redirectUri);
    setUiLoggedIn(true);
    verifyToken();
  } catch (e) {
    console.error(e);
    statusEl.textContent = "ошибка токена";
  }
})();

/* ======== VERIFY TOKEN ======== */

async function verifyToken() {
  const token = localStorage.getItem("access_token");
  if (!token) return;

  const resp = await fetch("https://login.eveonline.com/oauth/verify", {
    headers: { "Authorization": "Bearer " + token }
  });

  if (!resp.ok) return;

  const data = await resp.json();

  document.getElementById("charName").textContent = data.CharacterName || "???";
  document.getElementById("charId").textContent = data.CharacterID || "???";

  localStorage.setItem("character_id", String(data.CharacterID || ""));
  fetchStandings();
}

/* ======== FETCH STANDINGS ======== */

async function fetchStandings() {
  const token = localStorage.getItem("access_token");
  const charId = localStorage.getItem("character_id");
  const bars = document.getElementById("barsContainer");

  if (!token || !charId) return;

  bars.innerHTML = "Гружу standings...";

  const resp = await fetch(
    `https://esi.evetech.net/latest/characters/${charId}/standings/`,
    { headers: { "Authorization": "Bearer " + token } }
  );

  if (!resp.ok) {
    bars.innerHTML = "Ошибка загрузки standings";
    return;
  }

  const data = await resp.json();
  standingsRaw = data;

  const filtered = data.filter(x =>
    x.from_type === "faction" || x.from_type === "npc_corp"
  );

  const ids = [...new Set(filtered.map(x => x.from_id))];

  const namesResp = await fetch("https://esi.evetech.net/latest/universe/names/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(ids)
  });

  const names = await namesResp.json();
  const idToName = new Map(names.map(x => [x.id, x.name]));
  idToName.forEach((name, id) => nameCache.set(id, name));

  standingsPretty = filtered.map(x => ({
    id: x.from_id,
    type: x.from_type,
    name: idToName.get(x.from_id) || String(x.from_id),
    standing: x.standing
  }));

  populateCorpSelect();
  bars.innerHTML = "Выбери корпорацию.";
}

/* ======== SELECT + RENDER ======== */

function populateCorpSelect() {
  const select = document.getElementById("corpSelect");
  select.innerHTML = `<option value="">Выберите NPC-корпорацию</option>`;

  standingsPretty
    .filter(x => x.type === "npc_corp")
    .sort((a, b) => a.name.localeCompare(b.name))
    .forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name;
      select.appendChild(opt);
    });
}

async function renderBarsForCorpId(corpId) {
  const bars = document.getElementById("barsContainer");
  bars.innerHTML = "";

  const corp = standingsPretty.find(x =>
    x.type === "npc_corp" && String(x.id) === String(corpId)
  );
  if (!corp) return;

  let faction = null;

  try {
    const resp = await fetch(`https://esi.evetech.net/latest/corporations/${corp.id}/`);
    if (resp.ok) {
      const corpData = await resp.json();
      if (corpData.faction_id) {
        const fid = corpData.faction_id;

        faction =
          standingsPretty.find(x => x.type === "faction" && x.id === fid) ||
          { id: fid, type: "faction", name: nameCache.get(fid) || "Faction", standing: 0 };
      }
    }
  } catch {}

  if (faction) bars.appendChild(createBar(faction.name, faction.standing, "faction"));
  bars.appendChild(createBar(corp.name, corp.standing, "corp"));
}

/* ======== BAR RENDER ======== */

function createBar(label, standing, kind) {
  const wrapper = document.createElement("div");
  wrapper.style.marginBottom = "16px";

  const title = document.createElement("div");
  title.textContent = `${label} (${standing.toFixed(2)})`;
  title.style.marginBottom = "6px";
  title.style.fontWeight = "600";

  const bar = document.createElement("div");
  bar.style.position = "relative";
  bar.style.height = "18px";
  bar.style.background = "#262626";
  bar.style.borderRadius = "2px";

  const percent = ((Math.max(-10, Math.min(10, standing)) + 10) / 20) * 100;

  const marker = document.createElement("div");
  marker.style.position = "absolute";
  marker.style.left = `${percent}%`;
  marker.style.width = "2px";
  marker.style.height = "100%";
  marker.style.background = kind === "faction" ? "#5b7ea6" : "#6e9c78";

  bar.appendChild(marker);
  wrapper.appendChild(title);
  wrapper.appendChild(bar);

  return wrapper;
}

/* ======== EVENTS ======== */

document.addEventListener("click", e => {
  if (e.target.id === "logoutBtn") {
    localStorage.clear();
    setUiLoggedIn(false);
  }
  if (e.target.id === "refreshStandingsBtn") {
    fetchStandings();
  }
});

document.addEventListener("change", e => {
  if (e.target.id === "corpSelect") {
    renderBarsForCorpId(e.target.value);
  }
});

</script>
</body>
</html>
