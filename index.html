<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EVE Tracker</title>
</head>
<body>
  <h1>EVE Tracker 5</h1>

  <div style="display:flex; gap:12px; align-items:center; padding:12px; border:1px solid #ddd; border-radius:12px; max-width:520px;">
    <button id="loginBtn" style="padding:10px 14px; font-size:16px; cursor:pointer;">
      Login with EVE
    </button>
    <div>
      <div style="font-weight:600;">Статус:</div>
      <div id="status">не залогинен</div>
    </div>
  </div>

  <p style="margin-top:14px;">
    Версия: <span id="v"></span>
  </p>

<script>
const clientId = "4c2f7825780f4d0cba80a75d1a8a0c69";
const redirectUri = "https://instachad.github.io/test/";

// выбери нужные ESI scopes
const scopes = [
  "esi-wallet.read_character_wallet.v1",
  "esi-characters.read_standings.v1",
].join(" ");

document.getElementById('v').textContent = new Date().toISOString();
const statusEl = document.getElementById('status');

function base64UrlEncode(bytes) {
  let str = btoa(String.fromCharCode(...bytes));
  return str.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
}

async function sha256ToBase64Url(input) {
  const data = new TextEncoder().encode(input);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return base64UrlEncode(new Uint8Array(hash));
}

function randomString(len = 64) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
  const arr = new Uint8Array(len);
  crypto.getRandomValues(arr);
  return Array.from(arr, x => chars[x % chars.length]).join("");
}

async function startLogin() {
  const state = randomString(24);
  const codeVerifier = randomString(64);
  const codeChallenge = await sha256ToBase64Url(codeVerifier);

  sessionStorage.setItem("eve_state", state);
  sessionStorage.setItem("eve_code_verifier", codeVerifier);

  const authUrl =
  "https://login.eveonline.com/v2/oauth/authorize/?" +
  "response_type=code" +
  "&redirect_uri=" + encodeURIComponent(redirectUri) +
  "&client_id=" + encodeURIComponent(clientId) +
  "&scope=" + encodeURIComponent(scopes) +
  "&state=" + encodeURIComponent(state);

  window.location.href = authUrl;
}

async function exchangeCodeForTokenPKCE(code) {
  const codeVerifier = sessionStorage.getItem("eve_code_verifier");
  if (!codeVerifier) throw new Error("Missing code_verifier (sessionStorage cleared?)");

  const body = new URLSearchParams();
  body.append("grant_type", "authorization_code");
  body.append("code", code);
  body.append("client_id", clientId);
  body.append("code_verifier", codeVerifier);

  const resp = await fetch("https://login.eveonline.com/v2/oauth/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body.toString()
  });

  const data = await resp.json();
  if (!resp.ok) throw new Error(JSON.stringify(data));
  return data;
}

// обработка колбэка
(async function handleCallback() {
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get("code");
  const returnedState = urlParams.get("state");

  if (!code) {
    statusEl.textContent = localStorage.getItem("access_token") ? "залогинен" : "не залогинен";
    return;
  }

  const expectedState = sessionStorage.getItem("eve_state");
  if (!expectedState || returnedState !== expectedState) {
    statusEl.textContent = "ошибка безопасности (state mismatch)";
    return;
  }

  statusEl.textContent = "получаю токен...";

  try {
    const token = await exchangeCodeForTokenPKCE(code);
    localStorage.setItem("access_token", token.access_token);
    localStorage.setItem("refresh_token", token.refresh_token);

    statusEl.textContent = "залогинен";

    // подчистим URL, чтобы code не висел в адресной строке
    history.replaceState({}, document.title, redirectUri);
  } catch (e) {
    console.error(e);
    statusEl.textContent = "ошибка получения токена (см. консоль)";
  }
})();

document.getElementById('loginBtn').addEventListener('click', startLogin);
</script>
</body>
</html>
